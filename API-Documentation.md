# توثيق API "الريان" لمواقيت الصلاة - Al-Rayyan API

## نظرة عامة

هذا الـ API هو محرك متطور لحساب مواقيت الصلاة، يجمع بين الدقة العالية والمرونة في تحديد الموقع الجغرافي. صُمم ليدعم تطبيقات الصلاة الحديثة مع نظام كاش ذكي لتقليل الاعتماد على الخدمات الخارجية وضمان سرعة الاستجابة.

## نقطة النهاية (Endpoint)

- **URL**: `/api/v1/prayer-times`
- **طريقة الطلب**: `GET`
- **الوصف**: جلب مواقيت الصلاة بناءً على (الإحداثيات، اسم المدينة، أو عنوان الـ IP).

---

## طرق جلب الموقع (Resolution Logic)

يعمل الـ API بنظام أوليّات لضمان أفضل دقة ممكنة:

1. **الإحداثيات الجغرافية (أولوية قصوى):** إذا تم إرسال `lat` و `lon`.
2. **اسم المدينة:** إذا تم إرسال `city`.
3. **عنوان الـ IP (Fallback):** في حال عدم إرسال أي بيانات، يتم تحديد الموقع تلقائياً عبر عنوان IP المستخدم.

---

## معلمات الاستعلام (Query Parameters)

### 1. الموقع الجغرافي (Location)

- `lat` (اختياري): خط العرض (مثال: `30.0444`).
- `lon` (اختياري): خط الطول (مثال: `31.2357`).
- `city` (اختياري): اسم المدينة (مثال: `Cairo`).
- `country` (اختياري): اسم الدولة (اختياري مع المدينة، مثال: `Egypt`).

### 2. إعدادات الحساب (Settings)

- `method` (اختياري): طريقة الحساب. القيم المدعومة:
  - `EGYPT` (الافتراضي): الهيئة المصرية العامة للمساحة.
  - `UMM_AL_QURA`: أم القرى (مكة المكرمة).
  - `MWL`: رابطة العالم الإسلامي.
  - `KARACHI`: جامعة العلوم الإسلامية بكراتشي.
  - `NORTH_AMERICA`: ISNA (أمريكا الشمالية).
  - `DUBAI`: دبي.
  - `KUWAIT`: الكويت.
  - `QATAR`: قطر.
  - `SINGAPORE`: سنغافورة.
  - `TURKEY`: تركيا.
- `madhab` (اختياري): المذهب الفقهي (خاص بصلاة العصر). القيم المدعومة:
  - `SHAFI` (الافتراضي): الشافعي، المالكي، والحنبلي.
  - `HANAFI`: الحنفي.

---

## نظام الكاش الذكي (Unified Caching)

يحتفظ الـ API بقاعدة بيانات (MongoDB) لتخزين المواقع التي تم البحث عنها مسبقاً:

- **توفير الطلبات:** إذا طلب مستخدم نفس المدينة أو نفس الإحداثيات المسجلة لعنوان الـ IP الخاص به، يتم الرد فوراً من الكاش دون استهلاك API خارجي.
- **تحديث البيانات:** يتم ربط عناوين الـ IP الجديدة بالمدن الموجودة في الكاش لزيادة سرعة الطلبات المستقبلية.

---

## مثال على الاستجابة (Response Example)

```json
{
  "metadata": {
    "city": "Cairo",
    "country": "Egypt",
    "timeZone": "Africa/Cairo",
    "coordinates": {
      "latitude": 30.0444,
      "longitude": 31.2357
    }
  },
  "timings": {
    "Fajr": "04:30",
    "Sunrise": "06:00",
    "Dhuhr": "12:00",
    "Asr": "15:30",
    "Maghrib": "18:00",
    "Isha": "19:30"
  }
}
```

---

## الأخطاء (Error Handling)

- **503 (Service Unavailable):** مشكلة في الاتصال بقاعدة البيانات.
- **500 (Internal Server Error):** فشل في الوصل إلى خدمات تحديد الموقع الخارجية (Nominatim/IPGeolocation).

---

## كيفية التشغيل محلياً

1. تثبيت الحزم: `npm install`
2. إعداد ملف `.env` (يجب توفير `MONGO_URI` و `GEO_API_KEY`).
3. تشغيل الخادم: `npm run dev`
4. رابط الوصول: `http://localhost:3000/api/v1/prayer-times`

---

## التبعيات الرئيسية (Dependencies)

- **Adhan.js:** المحرك الأساسي لحساب المواقيت.
- **Nominatim (OSM):** لتحويل النصوص للاحداثيات والعكس (Reverse Geocoding).
- **Ipgeolocation.io:** لجلب المنطقة الزمنية وبيانات الـ IP.
- **Mongoose:** لإدارة نظام الكاش في MongoDB.
- **Moment-timezone:** لضبط الأوقات حسب المنطقة الزمنية المحلية.
